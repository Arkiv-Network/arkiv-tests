name: Spawn workers

on:
  workflow_dispatch:
    inputs:
      timeout_minutes:
        description: "Timeout for jobs"
        required: true
        default: "5"
      workers:
        description: "Workers"
        required: false
        default: "[\"luna\"]"

jobs:
  integration:
    name: Integration internal test
    timeout-minutes: ${{ fromJSON(inputs.timeout_minutes) }}
    # Use the matrix variable here
    runs-on: ${{ matrix.runner }}

    strategy:
      # If one runner fails, the others will still finish their tests
      fail-fast: false
      matrix:
        runner: ${{ fromJSON(inputs.workers) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone tests
        run: |
          git clone https://github.com/Arkiv-Network/tests.git

      - name: Prepare poetry
        run: |
          apt-get install python3-poetry -y
          cd tests/stress-tests
          poetry install

      - name: Run worker
        run: |
          poetry run locust -f tests/stress-tests/stress/l3/locustfile.py,tests/stress-tests/stress/explorer/locustfile.py --worker --master-host 49.13.209.55 --master-port 5557 --class-picker
